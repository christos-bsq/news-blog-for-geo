<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Signal North Daily CMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-site-verification" content="P8CN1vel-b-I7G-TkuQt5GSR_Zoh16Xcnrn0rFTD5mY" />
    <link rel="stylesheet" href="https://unpkg.com/@decapcms/editor-component-textarea@^3.0.0/dist/index.css" />
  </head>
  <body>
    <div id="nc-root"></div>
    <button id="identity-login" type="button" style="margin: 1rem; padding: 0.5rem 1rem;">
      Log in with Netlify Identity
    </button>
    <script>
      // Detect local development (Astro dev server or netlify dev on localhost)
      const isLocal = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1' ||
                      window.location.hostname.includes('localhost');
      
      if (isLocal) {
        // For local development, use GitHub backend (no Netlify Identity needed)
        // This allows login without setting up Netlify Identity locally
        window.CMS_MANUAL_INIT = true;
      }
      // For production (netlify.app), let CMS auto-load config.yml with git-gateway
    </script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      if (window.netlifyIdentity) {
        const loginButton = document.getElementById('identity-login');
        loginButton?.addEventListener('click', () => {
          window.netlifyIdentity.open('login');
        });

        // Reload CMS when auth status changes so Decap sees the new token.
        window.netlifyIdentity.on('login', () => window.location.reload());
        window.netlifyIdentity.on('logout', () => window.location.reload());

        // Handy for invite links: auto-open login if invite_token is present.
        window.netlifyIdentity.on('init', (user) => {
          if (!user) {
            const params = new URLSearchParams(window.location.search);
            if (params.has('invite_token')) {
              window.netlifyIdentity.open('login');
            }
          }
        });
      }
    </script>
    <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://unpkg.com/decap-cms@^3.0.16/dist/decap-cms.js"></script>
    <script>
      (function() {
        const isLocal = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' ||
                        window.location.hostname.includes('localhost');
        
        if (isLocal && window.CMS && window.jsyaml) {
          // Wait a bit to ensure CMS is fully loaded
          setTimeout(() => {
            // Load config and override backend for local dev
            fetch('/admin/config.yml')
              .then(response => response.text())
              .then(configText => {
                const config = window.jsyaml.load(configText);
                
                // Override backend to use GitHub instead of git-gateway for local dev
                config.backend = {
                  name: 'github',
                  repo: 'christos-bsq/news-blog-for-geo',
                  branch: 'main'
                };
                
                // Ensure collections is an array and not duplicated
                if (!Array.isArray(config.collections)) {
                  config.collections = [];
                }
                
                // Remove any potential duplicates by name
                const seen = new Set();
                config.collections = config.collections.filter(collection => {
                  if (!collection || !collection.name) return false;
                  if (seen.has(collection.name)) {
                    console.warn('Duplicate collection name found:', collection.name);
                    return false;
                  }
                  seen.add(collection.name);
                  return true;
                });
                
                // Initialize CMS with modified config
                window.CMS.init({ config });
              })
              .catch(err => {
                console.error('Error loading config:', err);
                // Fallback: initialize with basic GitHub config
                window.CMS.init({
                  config: {
                    backend: {
                      name: 'github',
                      repo: 'christos-bsq/news-blog-for-geo',
                      branch: 'main'
                    },
                    media_folder: 'public/uploads',
                    public_folder: '/uploads',
                    site_url: window.location.origin,
                    collections: []
                  }
                });
              });
          }, 100);
        }
        // If not local, CMS will auto-load config.yml with git-gateway backend
      })();
    </script>
  </body>
</html>
