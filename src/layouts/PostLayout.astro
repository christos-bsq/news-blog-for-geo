---
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import HeroImage from "@/components/HeroImage.astro";
import VideoEmbed from "@/components/VideoEmbed.astro";
import ExperimentMeta from "@/components/ExperimentMeta.astro";
import TagGroup from "@/components/TagGroup.astro";
import { format } from "@/utils/date";
import { getPostSlug } from "@/lib/postHelpers";

const { post, Content, htmlForClient } = Astro.props as {
  post: CollectionEntry<"posts">;
  Content: any;
  htmlForClient: string;
};
const frontmatter = post.data;
const slug = getPostSlug(post);
const isSSR = frontmatter.render_mode === "ssr";
const isMixed = frontmatter.render_mode === "mixed";
const isJSOnly = frontmatter.render_mode === "js-only";
const safePayload = JSON.stringify({ html: htmlForClient ?? "" }).replace(/<\/(script)/gi, "<\\/$1>");
const published = format(frontmatter.date);
const updated = frontmatter.updated ? format(frontmatter.updated) : null;
let jsonLdString: string | null = null;

if (frontmatter.json_ld) {
  if (typeof frontmatter.json_ld === "string") {
    try {
      jsonLdString = JSON.stringify(JSON.parse(frontmatter.json_ld));
    } catch {
      jsonLdString = frontmatter.json_ld;
    }
  } else {
    jsonLdString = JSON.stringify(frontmatter.json_ld);
  }
}
---
<BaseLayout
  title={`${frontmatter.title} | Signal North Daily`}
  description={frontmatter.description}
  image={frontmatter.image}
  indexable={frontmatter.indexable}
>
  <Fragment slot="head">
    <meta property="article:published_time" content={frontmatter.date.toISOString()} />
    {frontmatter.updated && <meta property="article:modified_time" content={frontmatter.updated.toISOString()} />}
    {jsonLdString && <script type="application/ld+json" set:html={jsonLdString}></script>}
  </Fragment>

  <article class="flex flex-col gap-8">
    <header class="flex flex-col gap-4">
      <p class="text-xs uppercase tracking-[0.3em] text-base-500">{frontmatter.category}</p>
      <h1 class="text-4xl font-semibold text-base-900">{frontmatter.title}</h1>
      <p class="text-lg text-base-600">{frontmatter.description}</p>
      <div class="text-sm text-base-500">
        Published {published}
        {updated && <span> Â· Updated {updated}</span>}
      </div>
      <TagGroup tags={frontmatter.tags} />
    </header>

    <HeroImage src={frontmatter.image} alt={frontmatter.image_alt} />
    <VideoEmbed url={frontmatter.video_url} />
    <ExperimentMeta post={post} />

    {isSSR && (
      <div class="prose prose-base max-w-none text-lg leading-relaxed text-base-700">
        <Content />
      </div>
    )}

    {isMixed && (
      <div class="space-y-4">
        <div class="rounded-3xl border border-base-200 bg-base-50 p-5 text-base text-base-600">
          <p class="font-semibold text-base-900">SSR intro</p>
          <p class="mt-2">{frontmatter.description}</p>
        </div>
        <div
          id="article-js"
          class="prose prose-base max-w-none text-base-700"
          data-slug={slug}
          data-experiment-type={frontmatter.experiment_type}
          data-client-delay-ms={frontmatter.client_delay_ms ?? 0}
          data-render-mode={frontmatter.render_mode}
        ></div>
      </div>
    )}

    {isJSOnly && (
      <div class="space-y-4">
        <p class="article-placeholder rounded-3xl border border-base-200 bg-base-50 p-5 text-base text-base-600">
          The complete article is injected client-side for this experiment. Bots without rendering capability should
          only see this placeholder.
        </p>
        <div
          id="article-js"
          class="prose prose-base max-w-none text-base-700"
          data-slug={slug}
          data-experiment-type={frontmatter.experiment_type}
          data-client-delay-ms={frontmatter.client_delay_ms ?? 0}
          data-render-mode={frontmatter.render_mode}
        ></div>
      </div>
    )}

    {(isMixed || isJSOnly) && (
      <script
        type="application/json"
        id="post-content"
        data-slug={slug}
        data-render-mode={frontmatter.render_mode}
      >
        {safePayload}
      </script>
    )}

    {(isMixed || isJSOnly) && (
      <script is:inline type="module">
        import initExperiments from '@/scripts/experiments.ts';
        initExperiments();
      </script>
    )}
  </article>
</BaseLayout>
